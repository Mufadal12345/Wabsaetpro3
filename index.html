<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ± ÙˆØ§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Firebase)</title>
    <!-- ØªØ¶Ù…ÙŠÙ† Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ************************************************************************* -->
    <!-- Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù config.js Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ© -->
    <!-- ************************************************************************* -->
    <script src="./config.js"></script> 
    
    <!-- ØªØ¶Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø§Øª Firebase SDK Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, orderBy, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙˆÙ‰ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØµØ­ÙŠØ­
        setLogLevel('Debug');
        
        // =========================================================================
        // === Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù…Ù† Ù…Ù„Ù config.js Ø§Ù„Ù…Ø­Ù…Ù‘Ù„ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ ===
        // =========================================================================
        const firebaseConfig = window.FIREBASE_CONFIG;
        const adminCredentials = window.ADMIN_CREDENTIALS;

        const appId = firebaseConfig.projectId || 'default-app-id'; // Project ID ÙŠØ³ØªØ®Ø¯Ù… ÙƒÙ…Ø¹Ø±Ù Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        const initialAuthToken = null; // Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„/Ø§Ù„Ù†Ù…ÙˆØ°Ø¬

        // ÙØ­Øµ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        if (firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY_HERE" || !firebaseConfig.projectId) {
            console.error("Firebase config is missing or using placeholder values! Check config.js");
            document.getElementById('loader').innerHTML = '<p class="text-rose-600 text-lg">Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ù…Ù„Ù **config.js** Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ.</p>';
            return;
        }
        
        // ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
        const ADMIN_NAME = adminCredentials.name;
        const ADMIN_SPECIALTY = adminCredentials.specialty;


        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Firestore (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†)
        window.FIRESTORE_PATHS = {
            SECTIONS: `artifacts/${appId}/public/data/sections`,
            REGISTRATIONS: `artifacts/${appId}/public/data/registrations`,
        };

        window.DB = db;
        window.AUTH = auth;

        // ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
        async function initialAuthAndLoad() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                window.globalApp.displayError('ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.');
                document.getElementById('loader').textContent = 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.';
            }
        }
        
        // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.globalApp.isAuthReady = true;
                window.globalApp.userId = user.uid;
                console.log("Firebase ready. User ID:", user.uid);
            } else {
                console.log("User is not signed in.");
                window.globalApp.isAuthReady = true;
            }
        });
        
        // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù€ module
        initialAuthAndLoad();
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        /* Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ù…Ø¹ ØªØ¯Ø±Ø¬ Ø®ÙÙŠÙ Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ù…Ù„ÙŠ Ø§Ù„ÙØ§ØªØ­ */
        .main-bg {
             background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%); /* Deep Indigo to Slate Black */
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ø¹Ø±Ø¶ */
        .section-body-rendered p { margin-bottom: 1rem; }
        .section-body-rendered strong { font-weight: bold; }
        .section-body-rendered ul { list-style: disc; margin-right: 1.5rem; padding-right: 0.5rem; margin-bottom: 1rem;}
        
        /* Ù„ÙˆÙ† Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© Ù„Ù„Ù…Ø­ØªÙˆÙ‰ (Sand Color Accent) */
        .highlight-quote {
            border-right: 4px solid #f59e0b; /* Amber */
            background-color: #fffbeb; /* Lightest Sand/Cream */
            padding: 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-style: italic;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            color: #1f2937;
        }
        .editor-textarea { min-height: 150px; }
        .error-flash { transition: opacity 0.5s ease-out; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¯ÙŠØ± (Velvet Red Accent) */
        .tab-button.active {
            border-color: #be123c; /* rose-700 */
            color: #be123c;
            background-color: #fce7f3; /* rose-50 */
        }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f3f4f6; font-weight: 600; }
    </style>
</head>
<body class="main-bg min-h-screen flex items-center justify-center p-4">

    <!-- App Container: Sand Color Background -->
    <div id="app" class="w-full max-w-5xl bg-stone-100 shadow-2xl rounded-xl p-6 md:p-10 transition-all duration-500">
        
        <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø¹Ø§Ù…Ø© -->
        <div id="global-error-message" class="hidden fixed top-0 right-0 m-4 p-3 bg-rose-700 text-white rounded-lg shadow-xl z-50 error-flash opacity-0">
            <p id="global-error-text" class="font-semibold"></p>
        </div>

        <!-- Loader / Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div id="loader" class="flex flex-col items-center justify-center h-96 text-gray-700">
            <svg class="animate-spin h-8 w-8 text-indigo-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg">Ø¬Ø§Ø±Ù ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...</p>
        </div>

        <!-- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Registration View) - Midnight Blue Accent -->
        <div id="registration-view" class="hidden">
            <h1 class="text-3xl font-extrabold text-indigo-900 mb-6 text-center">Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ±</h1>
            <p class="text-gray-600 mb-8 text-center">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„ØªØ¨Ø¯Ø£ ÙÙŠ Ø§Ø³ØªÙƒØ´Ø§Ù Ø£Ø«Ø±Ùƒ Ø§Ù„ÙÙƒØ±ÙŠ.</p>
            
            <form id="registration-form" class="space-y-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø§Ø³Ù…</label>
                    <input type="text" id="name" name="name" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-700 focus:border-indigo-700 transition duration-150">
                </div>
                
                <div>
                    <label for="specialty" class="block text-sm font-medium text-gray-700">Ø§Ù„ØªØ®ØµØµ</label>
                    <input type="text" id="specialty" name="specialty" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-700 focus:border-indigo-700 transition duration-150">
                </div>
                
                <button type="submit" id="reg-submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-indigo-800 hover:bg-indigo-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-700 transition duration-150">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù
                </button>
            </form>
            <p id="reg-error-message" class="text-rose-600 text-sm mt-4 text-center hidden"></p>
        </div>

        <!-- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Home View - Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ) - Midnight Blue Accent -->
        <div id="home-view" class="hidden">
            <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-300">
                <h1 class="text-3xl font-extrabold text-indigo-900">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ <span id="user-display-name">...</span>!</h1>
                <button onclick="window.location.reload();" class="text-sm text-indigo-700 hover:text-indigo-900 font-medium">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬/Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                </button>
            </div>

            <div id="main-menu" class="space-y-3">
                <div class="text-center mb-8 p-4 bg-stone-200 rounded-lg shadow-inner">
                    <h2 class="text-3xl font-extrabold text-indigo-900">ğŸ¨âœ¨ Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ±</h2>
                    <p class="text-lg text-gray-600 mt-1">Ø­ÙŠØ« ØªÙˆÙ„Ø¯ Ø§Ù„Ø£ÙÙƒØ§Ø± ÙˆØªØ¨Ù‚Ù‰ Ø®Ø§Ù„Ø¯Ø© âœ¨</p>
                </div>
                <div id="dynamic-sections-list">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
                </div>
            </div>

            <!-- Sand Background for content section -->
            <div id="section-content" class="hidden bg-stone-200 p-6 rounded-lg shadow-inner">
                <h2 id="section-title" class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2 border-gray-400"></h2>
                <div id="section-body" class="text-gray-700 leading-relaxed text-lg text-right section-body-rendered"></div>
                <!-- Button: Midnight Blue -->
                <button onclick="window.globalApp.changeView('main-menu')" class="mt-8 py-2 px-4 bg-indigo-800 text-white rounded-lg hover:bg-indigo-900 transition duration-150">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </button>
            </div>
        </div>

        <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ (Management View - Ù„Ù„Ù…Ø¯ÙŠØ±) - Velvet Red Accent -->
        <div id="management-view" class="hidden">
            <div class="flex justify-between items-center mb-8 pb-4 border-b border-rose-200">
                <h1 class="text-3xl font-extrabold text-rose-800">ğŸ” Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h1>
                <button onclick="window.location.reload();" class="text-sm text-rose-700 hover:text-rose-900 font-medium">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
            
            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
            <div class="flex mb-6 border-b border-gray-300">
                <button id="tab-content" onclick="window.globalApp.showAdminTab('content')" class="tab-button active py-2 px-4 border-b-2 border-transparent hover:border-rose-700 transition duration-150 text-rose-700 font-semibold">
                    Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù…
                </button>
                <button id="tab-participants" onclick="window.globalApp.showAdminTab('participants')" class="tab-button py-2 px-4 border-b-2 border-transparent hover:border-rose-700 transition duration-150 text-gray-600 font-semibold">
                    Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (<span id="participants-count">0</span>)
                </button>
            </div>
            
            <!-- Ù…Ø­ØªÙˆÙ‰ ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
            <div id="admin-content-tab" class="admin-tab">
                 <!-- Button: Velvet Red -->
                 <button onclick="window.globalApp.openEditorModal('new')" class="mb-6 py-2 px-4 bg-rose-600 text-white rounded-lg hover:bg-rose-700 transition duration-150 shadow-md">
                    + Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯
                </button>
                <div class="space-y-3" id="editable-sections-list">
                    <p class="text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...</p>
                </div>
            </div>

            <!-- Ù…Ø­ØªÙˆÙ‰ ØªØ¨ÙˆÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† -->
            <div id="admin-participants-tab" class="admin-tab hidden">
                <h2 class="text-xl font-bold text-rose-800 mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h2>
                <div id="participants-table-container" class="bg-white shadow-lg rounded-lg overflow-hidden">
                    <table id="participants-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„ØªØ®ØµØµ</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                            </tr>
                        </thead>
                        <tbody id="participants-table-body">
                            <tr><td colspan="3" class="text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Modal/Form) -->
        <div id="editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-stone-100 rounded-xl shadow-2xl w-full max-w-2xl p-6 relative overflow-y-auto max-h-screen">
                <h2 id="editor-title-text" class="text-2xl font-bold text-indigo-900 mb-4 border-b pb-2">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…</h2>
                <form id="section-editor-form" class="space-y-4">
                    <input type="hidden" id="editor-doc-id">
                    <input type="hidden" id="editor-type">
                    
                    <div>
                        <label for="editor-menu-title" class="block text-sm font-medium text-gray-700">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù„Ù„Ø§Ø®ØªØµØ§Ø±)</label>
                        <input type="text" id="editor-menu-title" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-700 focus:border-indigo-700">
                    </div>

                    <div>
                        <label for="editor-full-title" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø³Ù…)</label>
                        <input type="text" id="editor-full-title" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-700 focus:border-indigo-700">
                    </div>
                    
                    <div id="dynamic-editor-fields" class="space-y-4 border p-4 rounded-lg bg-stone-200">
                        <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡Ø§ Ù‡Ù†Ø§ -->
                    </div>
                    
                    <div class="flex justify-end space-x-3 space-x-reverse">
                        <button type="button" onclick="window.globalApp.closeEditorModal()" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-150">Ø¥Ù„ØºØ§Ø¡</button>
                         <!-- Button: Midnight Blue -->
                        <button type="submit" id="editor-save-btn" class="py-2 px-4 bg-indigo-800 text-white rounded-lg hover:bg-indigo-900 transition duration-150">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    </div>
                </form>
                
                <p id="modal-error-message" class="text-rose-600 text-sm mt-4 text-center hidden"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { doc, setDoc, collection, onSnapshot, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================================
        // === Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ù† config.js Ø§Ù„Ù…Ø­Ù…Ù‘Ù„ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ ===
        // ==========================================================
        const ADMIN_NAME = window.ADMIN_CREDENTIALS.name;
        const ADMIN_SPECIALTY = window.ADMIN_CREDENTIALS.specialty;

        window.globalApp = {
            isAuthReady: false,
            userId: null,
            sectionsData: [],
            participantsData: [],
            currentAdminTab: 'content',
            
            // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ ÙƒÙ…Ø§ ÙƒØ§Ù†Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
            templates: {
                'basic_highlight': {
                    editorFields: [
                        { key: 'p1', label: 'Ø§Ù„ÙÙ‚Ø±Ø© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©', type: 'textarea' },
                        { key: 'p2', label: 'Ø§Ù„ÙÙ‚Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©', type: 'textarea' },
                        { key: 'p3_highlight', label: 'Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¨Ø§Ø±Ø²Ø© ÙˆØ§Ù„Ù…Ù„Ø®ØµØ© (Ø³ØªØ¸Ù‡Ø± Ø¨Ø®Ø· Ø¹Ø±ÙŠØ¶ ÙˆØ¨Ø§Ø±Ø²)', type: 'textarea' },
                        { key: 'p4', label: 'ÙÙ‚Ø±Ø© Ø§Ù„Ø®ØªØ§Ù…', type: 'textarea' }
                    ],
                    render: (fields) => `
                        <p class="text-xl">${fields.p1}</p>
                        <p class="mt-4">${fields.p2}</p>
                        <!-- Midnight Blue Heading + Amber Accent -->
                        <p class="mt-4 text-2xl font-extrabold text-indigo-900 leading-snug border-b-2 border-amber-500 pb-2">${fields.p3_highlight}</p>
                        <p class="mt-4 text-lg text-amber-600">${fields.p4}</p>
                    `
                },
                'list_items': {
                     editorFields: [
                        { key: 'intro', label: 'Ù†Øµ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© (Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)', type: 'textarea' },
                        { key: 'listTitle', label: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±Ø¹ÙŠ', type: 'input' },
                        { key: 'listItems', label: 'Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¶Ø¹ ÙƒÙ„ Ø¹Ù†ØµØ± ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)', type: 'textarea', placeholder: 'Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ÙˆÙ„\nØ§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø«Ø§Ù†ÙŠ\n...' }
                    ],
                    render: (fields) => {
                        const items = (fields.listItems || '').split('\n').filter(item => item.trim() !== '');
                        const iconList = ['âœï¸', 'ğŸ¨', 'ğŸ’¬', 'ğŸ“š', 'â­', 'ğŸ’', 'ğŸ’¡', 'ğŸ†'];
                        let listHtml = items.map((item, index) => {
                            const icon = iconList[index % iconList.length];
                            // Midnight Blue Icon
                            return `<li class="flex items-start text-lg"><span class="ml-2 text-2xl text-indigo-700">${icon}</span> <span class="font-medium">${item.trim()}</span></li>`;
                        }).join('');

                        return `
                            <p class="text-xl">${fields.intro}</p>
                            <p class="mt-4 font-bold text-lg">${fields.listTitle}</p>
                            <ul class="space-y-3 list-none pr-0">${listHtml}</ul>
                        `;
                    }
                },
                'quote_block': {
                    editorFields: [
                        { key: 'p1', label: 'Ø§Ù„ÙÙ‚Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰', type: 'textarea' },
                        { key: 'p2', label: 'Ø§Ù„ÙÙ‚Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (ØªÙ…Ù‡ÙŠØ¯ Ù„Ù„Ø§Ù‚ØªØ¨Ø§Ø³)', type: 'textarea' },
                        { key: 'quote', label: 'Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø¥Ø·Ø§Ø± Ø¨Ø§Ø±Ø²)', type: 'textarea' }
                    ],
                    render: (fields) => `
                        <p class="text-xl">${fields.p1}</p>
                        <p class="mt-4 text-lg">${fields.p2}</p>
                        <blockquote class="highlight-quote">${fields.quote}</blockquote>
                    `
                },
                'final_call': {
                     editorFields: [
                        { key: 'call_title', label: 'Ø¬Ù…Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø³ØªØ¸Ù‡Ø± Ø¨Ø®Ø· Ø¹Ø±ÙŠØ¶)', type: 'textarea' },
                        { key: 'call_subtitle', label: 'Ø¬Ù…Ù„Ø© Ø§Ù„ØªØ´Ø¬ÙŠØ¹ (Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)', type: 'textarea' },
                        { key: 'final_signature', label: 'Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„Ø®ØªØ§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', type: 'input' }
                    ],
                    render: (fields) => `
                        <!-- Sand Background with Midnight Blue Accent -->
                        <div class="p-6 bg-stone-200 rounded-xl shadow-lg text-center">
                            <p class="text-3xl font-extrabold mb-4 leading-tight text-indigo-900">${fields.call_title}</p>
                            <p class="text-xl font-light italic text-gray-700">${fields.call_subtitle}</p>
                        </div>
                        <p class="mt-8 text-2xl font-extrabold text-indigo-900 text-center">ğŸ“ ${fields.final_signature}</p>
                    `
                }
            },
            
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù…Ù„Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„
            initialSectionsData: [
                { id: 'sec-1', order: 1, menuTitle: 'ğŸ§­ Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù‡Ù…ØŸ', title: 'ğŸ§­ Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù‡Ù…ØŸ', type: 'basic_highlight', 
                  fields: { 
                      p1: "ÙÙŠ ÙƒÙ„ Ø·Ø§Ù„Ø¨ØŒ Ù‡Ù†Ø§Ùƒ Ø¹Ø§Ù„Ù… ØºÙŠØ± Ù…ÙƒØªØ´Ù: ÙÙƒØ±Ø© Ø¹Ù…ÙŠÙ‚Ø©ØŒ Ù„ÙˆØ­Ø© Ù„Ù… ØªÙØ¹Ø±Ø¶ØŒ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ù„Ù… ØªØ¬Ø¯ Ù…Ù† ÙŠØ³Ù…Ø¹Ù‡Ø§.", 
                      p2: "Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ± Ù„ÙŠØ³ Ù…Ø´Ø±ÙˆØ¹Ù‹Ø§ Ø¹Ø§Ø¯ÙŠÙ‹Ø§â€¦",
                      p3_highlight: "Ø¥Ù†Ù‡ Ù…Ù†ØµØ© ØªØµÙ†Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ§Ù„ÙÙƒØ±ÙŠ Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨.",
                      p4: "Ù‡Ù†Ø§ØŒ Ù†ÙØ­ÙˆÙ‘Ù„ Ø§Ù„Ø£ÙÙƒØ§Ø± Ø§Ù„ØµØ§Ù…ØªØ© Ø¥Ù„Ù‰ Ø£Ø«Ø± Ø®Ø§Ù„Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©."
                  }},
                { id: 'sec-2', order: 2, menuTitle: 'ğŸ›ï¸ Ù…Ø§ Ù‡Ùˆ Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ±ØŸ', title: 'ğŸ›ï¸ Ù…Ø§ Ù‡Ùˆ Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ±ØŸ', type: 'list_items',
                  fields: { 
                      intro: "Ù‡Ùˆ Ù…Ø³Ø§Ø­Ø© ÙÙƒØ±ÙŠØ© Ø­Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© â€” Ø²Ø§ÙˆÙŠØ© Ø£Ùˆ Ø¬Ø¯Ø§Ø± Ø£Ùˆ Ù‚Ø§Ø¹Ø© â€” ØªØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„ÙÙ„Ø³ÙØ©ØŒ Ø§Ù„ÙÙ†ØŒ ÙˆØ§Ù„Ø¥Ø¨Ø¯Ø§Ø¹.", 
                      listTitle: "Ù…ÙƒØ§Ù† ÙŠÙØ¹Ø¨Ù‘Ø± ÙÙŠÙ‡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù† Ø°ÙˆØ§ØªÙ‡Ù… Ù…Ù† Ø®Ù„Ø§Ù„:",
                      listItems: "ØªØ£Ù…Ù„Ø§ØªÙ‡Ù… ÙˆØ£ÙÙƒØ§Ø±Ù‡Ù….\nÙ„ÙˆØ­Ø§ØªÙ‡Ù… ÙˆØ±Ø³ÙˆÙ…Ø§ØªÙ‡Ù… Ø§Ù„Ø±Ù…Ø²ÙŠØ©.\Ù†Ø¥Ù‚ØªØ¨Ø§Ø³Ø§ØªÙ‡Ù… ÙˆÙ…Ù‚Ø§Ù„Ø§ØªÙ‡Ù… Ø§Ù„Ù‚ØµÙŠØ±Ø©.\nØ£Ø³Ø¦Ù„ØªÙ‡Ù… Ø§Ù„ÙˆØ¬ÙˆØ¯ÙŠØ© ÙˆØ±Ø³Ø§Ø¦Ù„Ù‡Ù… Ù„Ù„Ø£Ø¬ÙŠØ§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©."
                  }},
                { id: 'sec-3', order: 3, menuTitle: 'ğŸ’¡ Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¹Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø®ØªÙ„ÙÙ‹Ø§ØŸ', title: 'ğŸ’¡ Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¹Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø®ØªÙ„ÙÙ‹Ø§ØŸ', type: 'quote_block',
                  fields: { 
                      p1: "Ù„Ø£Ù†Ù‡ ÙŠÙ…Ø³Ù‘ Ø¬ÙˆÙ‡Ø± Ø§Ù„Ø¥Ù†Ø³Ø§Ù†.", 
                      p2: "Ù†Ø­Ù† Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø£Ùˆ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§ØªØŒ Ø¨Ù„ Ù†ÙØ¸Ù‡Ø± Ù…Ø§ ÙŠØ¬Ø¹Ù„Ù†Ø§ Ø¨Ø´Ø±Ù‹Ø§: Ø§Ù„ØªÙÙƒÙŠØ±ØŒ Ø§Ù„Ø¥Ø­Ø³Ø§Ø³ØŒ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹.", 
                      quote: "Ø£Ù†Øª Ù„Ø³Øª Ù…Ø¬Ø±Ø¯ Ø±Ù‚Ù… Ø¬Ø§Ù…Ø¹ÙŠØŒ Ø£Ù†Øª ÙÙƒØ±Ø© ØªØ³ØªØ­Ù‚ Ø£Ù† ØªÙØ®Ù„Ù‘Ø¯."
                  }},
                { id: 'sec-7', order: 7, menuTitle: 'âœ¨ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø©', title: 'âœ¨ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø©', type: 'final_call',
                  fields: { 
                      call_title: "Ø´Ø§Ø±Ùƒ Ø¨ÙÙƒØ±Ø©ØŒ ÙƒÙ„Ù…Ø©ØŒ Ù„ÙˆØ­Ø©ØŒ Ø£Ùˆ Ø­ØªÙ‰ Ø³Ø¤Ø§Ù„ ÙˆØ¬ÙˆØ¯ÙŠ.", 
                      call_subtitle: "Ø§ØªØ±Ùƒ Ø£Ø«Ø±Ù‹Ø§ ÙŠÙØ´Ø¨Ù‡ÙƒØŒ Ù„Ø£Ù† Ù…Ø§ ØªØ²Ø±Ø¹Ù‡ Ø§Ù„ÙŠÙˆÙ… Ø³ÙŠÙƒÙˆÙ† Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© ØºØ¯Ù‹Ø§.",
                      final_signature: "Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ± â€” Ù„Ø£Ù† Ø§Ù„ÙÙƒØ± Ù‡Ùˆ Ù…Ø§ ÙŠØ¬Ø¹Ù„Ù†Ø§ Ø®Ø§Ù„Ø¯ÙŠÙ†."
                  }}
            ]
        };

        // ==========================================================
        //         2. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
        // ==========================================================

        window.globalApp.displayError = (message) => {
            const errorFlash = document.getElementById('global-error-message');
            const errorText = document.getElementById('global-error-text');
            
            errorText.textContent = message;
            errorFlash.classList.remove('hidden');
            setTimeout(() => {
                errorFlash.classList.remove('opacity-0');
                errorFlash.classList.add('opacity-100');
            }, 10); 

            setTimeout(() => {
                errorFlash.classList.remove('opacity-100');
                errorFlash.classList.add('opacity-0');
                setTimeout(() => errorFlash.classList.add('hidden'), 500); 
            }, 5000);
        };

        function showView(viewId) {
            const views = ['loader', 'registration-view', 'home-view', 'management-view'];
            views.forEach(id => {
                const view = document.getElementById(id);
                if (view) view.classList.add('hidden');
            });
            const activeView = document.getElementById(viewId);
            if (activeView) activeView.classList.remove('hidden');
        }

        document.getElementById('registration-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const specialty = document.getElementById('specialty').value.trim();
            const errorMessage = document.getElementById('reg-error-message');
            const submitBtn = document.getElementById('reg-submit-btn');
            
            errorMessage.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

            if (!name || !specialty) {
                errorMessage.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªØ®ØµØµ.';
                errorMessage.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù';
                return;
            }

            // Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ø¶Ù…Ø§Ù† ØªÙˆÙØ± DB Ùˆ Auth
            while (!window.globalApp.isAuthReady) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±
            if (name === ADMIN_NAME && specialty === ADMIN_SPECIALTY) {
                await window.globalApp.setupAdminView();
                showView('management-view');
                submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù';
                submitBtn.disabled = false;
                return;
            }

            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ: ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø§Ø¦Ø± ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Firestore
            try {
                const registrationsRef = collection(window.DB, window.FIRESTORE_PATHS.REGISTRATIONS);
                await addDoc(registrationsRef, {
                    name: name,
                    specialty: specialty,
                    registrationDate: serverTimestamp(),
                    userId: window.globalApp.userId, // Ø­ÙØ¸ UID Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
                });

                document.getElementById('user-display-name').textContent = name;
                window.globalApp.setupHomeView(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Firestore
                showView('home-view');
            } catch (error) {
                console.error("Error registering visitor:", error);
                window.globalApp.displayError('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²Ø§Ø¦Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                errorMessage.textContent = 'ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                errorMessage.classList.remove('hidden');
            } finally {
                submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù';
                submitBtn.disabled = false;
            }
        });

        // ØªØ´ØºÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Firebase
        window.onload = () => {
            const checkReady = setInterval(() => {
                if (window.globalApp.isAuthReady) {
                    clearInterval(checkReady);
                    showView('registration-view');
                }
            }, 100);
        };

        // ==========================================================
        //         3. Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Sections)
        // ==========================================================

        // ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Firestore
        window.globalApp.setupContentListener = (callback) => {
            const sectionsRef = collection(window.DB, window.FIRESTORE_PATHS.SECTIONS);
            // Ø§Ø³ØªØ®Ø¯Ù… onSnapshot Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
            const q = query(sectionsRef, orderBy('order', 'asc'));

            return onSnapshot(q, (snapshot) => {
                const sections = [];
                snapshot.forEach(doc => {
                    sections.push({ id: doc.id, ...doc.data() });
                });
                window.globalApp.sectionsData = sections;
                callback(sections);
            }, async (error) => {
                console.error("Error listening to sections:", error);
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙØ§Ø±ØºØ© (Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©)
                if (window.globalApp.sectionsData.length === 0) {
                     await window.globalApp.initializeSections();
                } else {
                     window.globalApp.displayError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                }
            });
        };
        
        // ÙˆØ¸ÙŠÙØ© Ù…Ù„Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„
        window.globalApp.initializeSections = async () => {
            const sectionsRef = collection(window.DB, window.FIRESTORE_PATHS.SECTIONS);
            
            // ØªØ­Ù‚Ù‚ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙØ§Ø±ØºØ©
            const snapshot = await getDocs(sectionsRef);
            if (snapshot.empty) {
                console.log("Sections collection is empty. Initializing with default data.");
                for (const section of window.globalApp.initialSectionsData) {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… ID Ù…Ø¹ÙŠÙ† Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„ÙŠÙ‡
                    await setDoc(doc(sectionsRef, section.id), section);
                }
                window.globalApp.displayError('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
            }
        };

        // ==========================================================
        //         4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
        // ==========================================================

        window.globalApp.setupHomeView = () => {
            // Ø¨Ø¯Ø£ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ
            window.globalApp.setupContentListener(window.globalApp.renderHomeSections);
        };
        
        window.globalApp.renderHomeSections = (sections) => {
            const listElement = document.getElementById('dynamic-sections-list');
            listElement.innerHTML = '';
            
            sections.forEach(section => {
                const div = document.createElement('div');
                // Sand Background + Midnight Blue Accent
                div.className = 'cursor-pointer p-4 bg-stone-200 hover:bg-stone-300 rounded-xl shadow-sm transition duration-200 border-r-4 border-indigo-700';
                
                const template = window.globalApp.templates[section.type];
                const bodyHtml = template ? template.render(section.fields) : `<p>Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ù„Ø¨ ${section.type}.</p>`;

                div.onclick = () => window.globalApp.showSection(section.id, section.title, bodyHtml);
                // Midnight Blue Text
                div.innerHTML = `
                    <h3 class="text-xl font-semibold text-indigo-900">${section.order}. ${section.menuTitle}</h3>
                    <p class="text-xs text-gray-500 mt-1 truncate">${section.menuTitle.split(' ')[2] || '...'}</p>
                `;
                listElement.appendChild(div);
            });
        };

        window.globalApp.changeView = (target) => {
            const mainMenu = document.getElementById('main-menu');
            const sectionContent = document.getElementById('section-content');
            
            if (target === 'main-menu') {
                mainMenu.classList.remove('hidden');
                sectionContent.classList.add('hidden');
            }
        };

        window.globalApp.showSection = (id, title, bodyHtml) => {
            document.getElementById('section-title').textContent = title;
            document.getElementById('section-body').innerHTML = bodyHtml;
            
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('section-content').classList.remove('hidden');
        };

        // ==========================================================
        //         5. ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù„Ù„Ù…Ø¯ÙŠØ±)
        // ==========================================================

        window.globalApp.setupAdminView = async () => {
            // Ø¨Ø¯Ø£ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
            window.globalApp.setupContentListener(window.globalApp.renderEditableSections);
            // Ø¨Ø¯Ø£ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
            window.globalApp.setupParticipantsListener();
        };

        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
        window.globalApp.renderEditableSections = (sections) => {
            const listElement = document.getElementById('editable-sections-list');
            listElement.innerHTML = '';
            
            sections.forEach(section => {
                const div = document.createElement('div');
                // Sand Background + Velvet Red Accent
                div.className = 'flex justify-between items-center p-4 bg-stone-200 hover:bg-stone-300 rounded-lg shadow-sm border-r-4 border-rose-700 transition duration-200';
                div.innerHTML = `
                    <div class="flex-1">
                        <!-- Velvet Red Text -->
                        <h3 class="text-lg font-semibold text-rose-800">${section.order}. ${section.menuTitle}</h3>
                        <p class="text-xs text-gray-500">Ø§Ù„Ù‚Ø§Ù„Ø¨: ${section.type}</p>
                    </div>
                    <!-- Velvet Red Button -->
                    <button onclick="window.globalApp.openEditorModal('${section.id}')" class="py-1 px-3 bg-rose-700 text-white text-sm rounded-md hover:bg-rose-800 transition ml-2">ØªØ¹Ø¯ÙŠÙ„</button>
                `;
                listElement.appendChild(div);
            });
             if (sections.length === 0) {
                 listElement.innerHTML = '<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯.</p>';
            }
        };

        // ÙˆØ¸ÙŠÙØ© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
        window.globalApp.setupParticipantsListener = () => {
            const participantsRef = collection(window.DB, window.FIRESTORE_PATHS.REGISTRATIONS);
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            const q = query(participantsRef, orderBy('registrationDate', 'desc'));

            onSnapshot(q, (snapshot) => {
                window.globalApp.participantsData = [];
                snapshot.forEach(doc => {
                    window.globalApp.participantsData.push({ id: doc.id, ...doc.data() });
                });
                window.globalApp.renderParticipantsTable();
            }, (error) => {
                console.error("Error listening to participants:", error);
                window.globalApp.displayError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
            });
        };

        // ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙÙŠ Ø¬Ø¯ÙˆÙ„
        window.globalApp.renderParticipantsTable = () => {
            const tbody = document.getElementById('participants-table-body');
            const countSpan = document.getElementById('participants-count');
            tbody.innerHTML = '';
            
            const participants = window.globalApp.participantsData;
            countSpan.textContent = participants.length;

            if (participants.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ù…Ø³Ø¬Ù„ÙˆÙ† Ø¨Ø¹Ø¯.</td></tr>';
                return;
            }

            participants.forEach(p => {
                const date = p.registrationDate ? new Date(p.registrationDate.seconds * 1000).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.name || 'ØºÙŠØ± Ù…ÙØ¯Ø®Ù„'}</td>
                    <td>${p.specialty || 'ØºÙŠØ± Ù…ÙØ¯Ø®Ù„'}</td>
                    <td>${date}</td>
                `;
                tbody.appendChild(row);
            });
        };
        
        // ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
        window.globalApp.showAdminTab = (tabName) => {
            window.globalApp.currentAdminTab = tabName;
            const tabs = {
                content: document.getElementById('admin-content-tab'),
                participants: document.getElementById('admin-participants-tab')
            };
            
            Object.keys(tabs).forEach(key => {
                const tab = tabs[key];
                const button = document.getElementById(`tab-${key}`);
                
                if (key === tabName) {
                    tab.classList.remove('hidden');
                    button.classList.add('active');
                    button.classList.remove('text-gray-600');
                    button.classList.add('text-rose-700'); // Velvet Red
                } else {
                    tab.classList.add('hidden');
                    button.classList.remove('active');
                    button.classList.remove('text-rose-700');
                    button.classList.add('text-gray-600');
                }
            });
        };

        // ==========================================================
        //         6. ÙˆØ¸Ø§Ø¦Ù Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ©
        // ==========================================================
        
        // ØªÙˆÙ„ÙŠØ¯ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨
        function generateEditorFields(sectionData) {
            const container = document.getElementById('dynamic-editor-fields');
            container.innerHTML = '';
            const templateType = sectionData.type || 'basic_highlight';
            const template = window.globalApp.templates[templateType];
            
            document.getElementById('editor-type').value = templateType;

            if (!template) {
                container.innerHTML = `<p class="text-rose-600">Ø®Ø·Ø£: Ø§Ù„Ù‚Ø§Ù„Ø¨ (${templateType}) ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….</p>`;
                return;
            }

            template.editorFields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'space-y-1';
                
                let inputElement;
                const fieldId = `editor-field-${field.key}`;

                if (field.type === 'textarea') {
                    inputElement = document.createElement('textarea');
                    inputElement.className = 'editor-textarea mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-700 focus:border-indigo-700';
                    inputElement.placeholder = field.placeholder || '';
                } else {
                    inputElement = document.createElement('input');
                    inputElement.type = 'text';
                    inputElement.className = 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-700 focus:border-indigo-700';
                }
                
                inputElement.id = fieldId;
                inputElement.required = true;
                
                const fieldValue = sectionData.fields ? sectionData.fields[field.key] : '';
                inputElement.value = fieldValue;
                
                const label = document.createElement('label');
                label.htmlFor = fieldId;
                label.className = 'block text-sm font-medium text-gray-700';
                label.textContent = field.label;

                div.appendChild(label);
                div.appendChild(inputElement);
                container.appendChild(div);
            });
        }


        // ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„/Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        window.globalApp.openEditorModal = (docId) => {
            const modal = document.getElementById('editor-modal');
            const form = document.getElementById('section-editor-form');
            const saveBtn = document.getElementById('editor-save-btn');
            const titleText = document.getElementById('editor-title-text');
            document.getElementById('modal-error-message').classList.add('hidden');
            
            form.reset();
            
            let sectionData = {};
            let isNew = docId === 'new';

            if (isNew) {
                document.getElementById('editor-doc-id').value = '';
                titleText.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯';
                saveBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­ÙØ¸';
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                sectionData = {
                    type: 'basic_highlight', 
                    menuTitle: 'Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯', 
                    title: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯', 
                    fields: { p1: '', p2: '', p3_highlight: '', p4: '' }
                };
            } else {
                titleText.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ';
                saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
                document.getElementById('editor-doc-id').value = docId;
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                sectionData = window.globalApp.sectionsData.find(sec => sec.id === docId);
                if (!sectionData) {
                    window.globalApp.displayError('ÙØ´Ù„ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©.');
                    return;
                }
            }

            document.getElementById('editor-menu-title').value = sectionData.menuTitle || '';
            document.getElementById('editor-full-title').value = sectionData.title || '';
            
            generateEditorFields(sectionData);

            modal.classList.remove('hidden');
        };

        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        window.globalApp.closeEditorModal = () => {
            document.getElementById('editor-modal').classList.add('hidden');
        };
        
        // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Firestore
        document.getElementById('section-editor-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = document.getElementById('editor-doc-id').value;
            const menuTitle = document.getElementById('editor-menu-title').value;
            const fullTitle = document.getElementById('editor-full-title').value;
            const type = document.getElementById('editor-type').value;
            const saveBtn = document.getElementById('editor-save-btn');
            const modalError = document.getElementById('modal-error-message');
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            modalError.classList.add('hidden');
            
            try {
                // 1. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                const newFields = {};
                const template = window.globalApp.templates[type];
                template.editorFields.forEach(field => {
                    newFields[field.key] = document.getElementById(`editor-field-${field.key}`).value.trim();
                });

                // 2. ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…
                const sectionData = {
                    menuTitle: menuTitle,
                    title: fullTitle,
                    type: type,
                    fields: newFields,
                    updatedAt: serverTimestamp()
                };

                const sectionsRef = collection(window.DB, window.FIRESTORE_PATHS.SECTIONS);

                if (docId) {
                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯
                    const docRef = doc(sectionsRef, docId);
                    await updateDoc(docRef, sectionData);
                } else {
                    // Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯
                    const currentMaxOrder = window.globalApp.sectionsData.length > 0 ? 
                                           Math.max(...window.globalApp.sectionsData.map(s => s.order)) : 0;
                    
                    const newSection = {
                        ...sectionData,
                        order: currentMaxOrder + 1,
                        createdAt: serverTimestamp()
                    };
                    await addDoc(sectionsRef, newSection);
                }
                
                window.globalApp.closeEditorModal();
                window.globalApp.displayError('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');

            } catch (error) {
                console.error("Error saving section:", error);
                modalError.textContent = `ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…. Ø§Ù„Ø®Ø·Ø£: ${error.message}.`;
                modalError.classList.remove('hidden');
                window.globalApp.displayError('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = docId ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­ÙØ¸';
            }
        });
    </script>
</body>
</html>